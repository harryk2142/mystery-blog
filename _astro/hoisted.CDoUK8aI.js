import{initializeApp as P}from"https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";import{getFirestore as l,connectFirestoreEmulator as E,query as h,collection as u,where as I,getDocs as x,getDoc as q,doc as D,addDoc as v,orderBy as F,setDoc as R}from"https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-lite.js";import{el as r,mount as f}from"https://esm.sh/redom";import S from"https://esm.sh/umbrellajs";import"./hoisted.BEIlyJ2S.js";let b;const d=async()=>b||(b=await N(),b),N=async()=>{const t={apiKey:FB_API_KEY,projectId:FB_PROJECT_ID},e=P(t);return b=e,e},y="posts",k={toFirestore(t){return{title:t.blogPostIdentifier,likes:t.likes}},fromFirestore(t){const e=t.data();return{id:t.id,blogPostIdentifier:e.blogPostIdentifier??"no title",likes:e.likes??0}}},L=async(t,e)=>{const n=l(t);location.hostname==="localhost"&&E(n,"127.0.0.1",8088);const o=h(u(n,y).withConverter(k),I("blogPostIdentifier","==",e)),i=(await x(o)).docs.at(0)?.ref;if(i)return(await q(i)).data()},T=async(t,e)=>{const n=l(t),o=D(n,y,e).withConverter(k);if(o)return(await q(o)).data()},U=async(t,e)=>{const n=l(t),o=h(u(n,y).withConverter(k),I("blogPostIdentifier","==",e));if((await x(o)).size===0){const i={blogPostIdentifier:e,likes:0};return(await v(u(n,y),i)).id}return"0"},K=async t=>{const e=await d();return await U(e,t)},O=async t=>{const e=await d();return await L(e,t)},C="posts",V={toFirestore(t){return{date:t.date,username:t.username??"ANONYM",text:t.text??""}},fromFirestore(t){const e=t.data(),n=t.ref.parent.parent?.id;return{id:t.id,postID:n,date:e.date??"0",formattedDate:new Date(e.date).toLocaleString(),username:e.username??"ANONYM",text:e.text??"",parentID:e.parentID??"",replies:[]}}},Y=async(t,e)=>{const n=l(t),o=h(u(n,C,e,"comments").withConverter(V),F("date")),s=await x(o),i=[];return s.forEach(a=>{i.push(a.data())}),i},M=async(t,e,n,o)=>{const s=l(t),i={date:Date.now(),username:o,text:n};await v(u(s,C,e,"comments"),i)},_=async(t,e,n,o,s)=>{const i=l(t),a={date:Date.now(),username:s,text:o,parentID:n};await v(u(i,C,e,"comments"),a)},W=async t=>{const e=await d();return await Y(e,t)},z=async(t,e,n)=>{const o=await d();await M(o,t,e,n)},j=async(t,e,n,o)=>{const s=await d();await _(s,t,e,n,o)},H=async t=>{t.target.disabled=!0;const e=S(t.target).parent().parent();e.find("[name='protection']").first().value&&console.error("ERROR");const i=e.find("[name='blog-post']").first().value,m=e.find("[name='parent-comment']").first().value;let c=e.find("[name='input-username']").first().value;const p=e.find("[name='input-text']").first().value;if(!p){console.warn("EMPTY INPUT");return}c||(c="ANONYM"),p&&(m?await j(i,m,p,c):await z(i,p,c),setTimeout(()=>{window.location.reload()},500))},J=t=>{const e=t.target.id.split("-").at(t.target.id.split("-").length-1),n=document.querySelector("#reply-box-"+e),o=n?.parentElement;o&&n&&o.removeChild(n)},A=(t,e,n="")=>{const o=n||e,s="protection-"+o,i="blog-post-"+o,a=n?"parent-comment-"+n:"",m="input-username-"+o,g="input-text-"+o,c="senden-btn-"+o,w="abbrechen-btn-"+o,p=r("div",{class:"comment-form"},[r("input",{type:"hidden",id:s,name:"protection"}),r("input",{type:"hidden",id:i,name:"blog-post",value:e}),n&&r("input",{type:"hidden",id:a,name:"parent-comment",value:n}),r("label",{id:"lbl-input-username",for:m},"Username (optional):"),r("input",{type:"text",id:m,name:"input-username",autocomplete:"off",placeholder:"Anonym",class:"username"}),r("label",{id:"lbl-input-text",for:g},"Kommentar:"),r("textarea",{id:g,name:"input-text",cols:45,rows:8,placeholder:"Hier eingeben...",autocomplete:"off",class:"text"}),r("div",{class:"comment-form-btn-block"},[n&&r("button",{id:w,name:w,type:"button",class:"abbrechen-btn",onclick:J},"Abbrechen"),r("button",{id:c,name:c,type:"button",class:"primary absenden-btn",onclick:H},"Absenden")])]);f(t,p)},$=(t,e)=>{const n=r("div.comment-replies");e.forEach(o=>{const s=B(o);f(n,s)}),f(t,n)},B=t=>{const e=r("div",{class:"comment-block"},[r("span.comment-username",t.username),r("div",[r("span","schrieb am "),r("span.comment-date",t.formattedDate??"")]),r("div",r("span.comment-text",t.text)),r("div",r("button.reply-btn#reply-btn-"+t.id,{onclick:G},"Antworten"))]);return t.replies&&t.replies.length>0&&$(e,t.replies),e},G=t=>{let e=document.querySelector("#blog-post-id").innerText;const n=t.target,o=n.id,s=o.split("-").at(o.split("-").length-1),i=r("div#reply-box-"+s);A(i,e,s),f(n.parentNode,i)},Q=t=>{function e(o){o.forEach(s=>{const i=o.filter(a=>a.parentID===s.id);i.length>0&&(s.replies=i,e(i))})}return e(t),t.filter(o=>!o.parentID)},X=t=>{W(t).then(e=>{if(e.length>0){const n=e.length;S("#comments-counter").text(n.toString()),Q(e).forEach(s=>{const i=B(s),a=document.querySelector("#comments");a&&f(a,i)})}else{const n=r("span");n.innerText="Keine Kommentare vorhanden",document.getElementById("comments")?.appendChild(n)}})},Z=async(t,e)=>{const n=l(t),o=await T(t,e);if(o){o.likes++;const s=o.likes;return await R(D(n,"posts",e),o),s}return 0},tt=async t=>{const e=await d(),n=await T(e,t);n?.likes&&(document.querySelector("#like-counter").innerText=n.likes+"")},et=async t=>{const e=await d();return Z(e,t)};document.querySelector("#comment-btn")?.addEventListener("click",()=>{document.querySelector("#comments-section")?.scrollIntoView()});setTimeout(async()=>{const t=document.querySelector("#blog-post-identifier").innerText;O(t).then(async e=>{if(e)document.querySelector("#blog-post-id").innerText=e.id;else{const s=await K(t);document.querySelector("#blog-post-id").innerText=s}let n=document.querySelector("#blog-post-id").innerText;tt(n),document.querySelector("#like-btn").addEventListener("click",async()=>{const s=await et(n);document.querySelector("#like-counter").innerText=s.toString()});const o=document.querySelector("#comment-form-container");o&&A(o,n),X(n)})},500);
